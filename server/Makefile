CC       := /opt/m68k-amigaos/bin/m68k-amigaos-gcc
AS       := /opt/m68k-amigaos/bin/m68k-amigaos-as
CFLAGS   := -Wall -MMD
LDFLAGS  := -s -noixemul -L/opt/m68k-amigaos//m68k-amigaos/libnix/lib -L/opt/m68k-amigaos//m68k-amigaos/libnix/lib/libnix
LDLIBS   := -lnix -lamiga -ldebug
SRCFILES := cli.c debugger.c m68kdasm.c main.c serio.c server.c util.c

.PHONY: all musashi clean

all: musashi cwdebug

# This target is just there to trigger a build of m68k.h on a clean build. On a clean build the object
# files dont' have any dependencies because the rules with dependencies (the *.d files) haven't been
# created yet (they get created along with the object files).
musashi: m68k.h m68kdasm.c

clean:
	rm -f *.o *.d m68k.h m68kdasm.c cwdebug

# TODO: use current version of Musashi
%.h: %.h.patch
	rm -f $@ && wget -q https://raw.githubusercontent.com/kstenerud/Musashi/3ae92a71669a3689fc01a25191e46afa68dfdcce/$@
	patch -p0 < $@.patch

%.c: %.c.patch
	rm -f $@ && wget -q https://raw.githubusercontent.com/kstenerud/Musashi/3ae92a71669a3689fc01a25191e46afa68dfdcce/$@
	patch -p0 < $@.patch

exc-handler.o: exc-handler.s
	$(AS) -o $@ $^

cwdebug: $(SRCFILES:%.c=%.o) exc-handler.o
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)

# include rules with all dependencies for the object files generated by the compiler (by the -MMD option)
# see http://www.microhowto.info/howto/automatically_generate_makefile_dependencies.html for more details
-include $(SRCFILES:%.c=%.d)
